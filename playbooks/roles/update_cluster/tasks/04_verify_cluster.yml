---
# Verify cluster status after upgrade

- name: Find home directory for UID 1000
  command: getent passwd 1000
  register: getent_passwd_output
  changed_when: false
  when: "'master' in group_names"

- name: Set home directory variable
  set_fact:
    user_home_directory: "{{ getent_passwd_output.stdout.split(':')[5] }}"
  when: 
  - "'master' in group_names" 
  - getent_passwd_output.stdout != ""

- name: Define the user name with UID 1000
  command: getent passwd 1000
  register: getent_passwd_result
  changed_when: false

- name: Set user name variable from getent passwd output
  set_fact:
    uid_1000_user: "{{ getent_passwd_result.stdout.split(':')[0] }}"
  when: getent_passwd_result.stdout != ''

- name: Get all node versions after upgrade
  ansible.builtin.command:
    cmd: kubectl get nodes -o jsonpath='{range .items[*]}{.metadata.name}{\"\t\"}{.status.nodeInfo.kubeletVersion}{\"\n\"}{end}'
  become: true
  become_user: "{{ uid_1000_user }}"
  environment:
    KUBECONFIG: "{{ user_home_directory }}/.kube/config"
  when: inventory_hostname == groups['master'][0]
  register: node_versions_after
  changed_when: false

- name: Display node versions after upgrade
  debug:
    msg: "{{ node_versions_after.stdout_lines }}"
  when: 
    - inventory_hostname == groups['master'][0]
    - node_versions_after.stdout is defined

- name: Check all nodes are Ready
  ansible.builtin.command:
    cmd: kubectl get nodes --no-headers | grep -v " Ready " | wc -l
  become: true
  become_user: "{{ uid_1000_user }}"
  environment:
    KUBECONFIG: "{{ user_home_directory }}/.kube/config"
  when: inventory_hostname == groups['master'][0]
  register: not_ready_nodes
  changed_when: false

- name: Display cluster status
  debug:
    msg: "Cluster upgrade completed. Nodes not ready: {{ not_ready_nodes.stdout | trim }}"
  when: 
    - inventory_hostname == groups['master'][0]
    - not_ready_nodes.stdout is defined

- name: Verify all pods are running
  ansible.builtin.command:
    cmd: kubectl get pods --all-namespaces --field-selector=status.phase!=Running,status.phase!=Succeeded --no-headers | wc -l
  become: true
  become_user: "{{ uid_1000_user }}"
  environment:
    KUBECONFIG: "{{ user_home_directory }}/.kube/config"
  when: inventory_hostname == groups['master'][0]
  register: not_running_pods
  changed_when: false
  ignore_errors: true

- name: Display pod status
  debug:
    msg: "Pods not running: {{ not_running_pods.stdout | trim }}"
  when: 
    - inventory_hostname == groups['master'][0]
    - not_running_pods.stdout is defined

