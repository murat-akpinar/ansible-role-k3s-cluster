---
# Check current K3s versions on all nodes

- name: Get current K3s version on master nodes
  shell: k3s --version 2>/dev/null | grep -oP 'k3s version \K[^\s]+' || echo "not_installed"
  register: current_k3s_version_master
  changed_when: false
  failed_when: false
  when: "'master' in group_names"
  become: true

- name: Get current K3s version on worker nodes
  shell: |
    if command -v k3s-agent &> /dev/null; then
      k3s-agent --version 2>/dev/null | grep -oP 'k3s version \K[^\s]+' || echo "not_installed"
    elif [ -f /usr/local/bin/k3s-agent ]; then
      /usr/local/bin/k3s-agent --version 2>/dev/null | grep -oP 'k3s version \K[^\s]+' || echo "not_installed"
    else
      echo "not_installed"
    fi
  register: current_k3s_version_worker
  changed_when: false
  failed_when: false
  when: "'worker' in group_names"
  become: true

- name: Display current K3s versions
  debug:
    msg: "Node {{ inventory_hostname }}: Current={{ current_k3s_version_master.stdout | default(current_k3s_version_worker.stdout) }}, Target={{ k3s_target_version | default(k3s_version | default('not specified')) }}"
  when: "'master' in group_names or 'worker' in group_names"

- name: Set fact for current version (trimmed)
  set_fact:
    current_k3s_version: "{{ (current_k3s_version_master.stdout | default(current_k3s_version_worker.stdout)) | trim }}"
  when: "'master' in group_names or 'worker' in group_names"

- name: Set target version for upgrade (use k3s_upgrade_version if specified, otherwise k3s_version)
  set_fact:
    k3s_target_version: "{{ k3s_upgrade_version | default('') | trim | default(k3s_version | default(''), true) | trim }}"
  when: "'master' in group_names or 'worker' in group_names"
  run_once: true

- name: Check if downgrade attempt (prevent downgrade)
  shell: |
    python3 << 'EOF'
    import re
    import sys
    
    def parse_version(version_str):
        """Parse K3s version string (e.g., 'v1.32.8+k3s1') to tuple (major, minor, patch)"""
        if version_str == "not_installed":
            return (0, 0, 0)
        # Remove 'v' prefix and '+k3s1' suffix, extract version numbers
        version_clean = re.sub(r'^v', '', version_str)
        version_clean = re.sub(r'\+.*$', '', version_clean)
        parts = version_clean.split('.')
        major = int(parts[0]) if len(parts) > 0 else 0
        minor = int(parts[1]) if len(parts) > 1 else 0
        patch = int(parts[2]) if len(parts) > 2 else 0
        return (major, minor, patch)
    
    current = "{{ current_k3s_version }}".strip()
    target = "{{ k3s_target_version }}".strip()
    
    if current == "not_installed":
        # If not installed, allow any version
        sys.exit(0)
    
    if not target or target == "":
        print(f"ERROR: Target version (k3s_upgrade_version or k3s_version) is not specified in k3s_setup/vars/main.yml")
        sys.exit(1)
    
    current_ver = parse_version(current)
    target_ver = parse_version(target)
    
    # Compare versions
    if target_ver < current_ver:
        print(f"SKIP: Current version ({current}) is higher than target ({target}). Skipping upgrade.")
        sys.exit(2)  # Special exit code for skip
    elif target_ver == current_ver:
        print(f"SKIP: Versions match ({current}). No upgrade needed.")
        sys.exit(2)  # Special exit code for skip
    else:
        print(f"UPGRADE: Current version ({current}) is lower than target ({target}). Upgrade needed.")
        sys.exit(0)
    EOF
  register: version_check_result
  changed_when: false
  failed_when: false
  when: 
    - "'master' in group_names or 'worker' in group_names"
    - current_k3s_version != "not_installed"
    - not upgrade_force | default(false)
  run_once: true

- name: Fail if target version not specified
  fail:
    msg: "❌ TARGET VERSION NOT SPECIFIED! Please set k3s_upgrade_version or k3s_version in playbooks/roles/k3s_setup/vars/main.yml (Example: k3s_upgrade_version: \"v1.32.9+k3s1\")"
  when: 
    - "'master' in group_names or 'worker' in group_names"
    - version_check_result is defined
    - version_check_result.rc is defined
    - version_check_result.rc == 1
    - not upgrade_force | default(false)
  run_once: true

- name: Skip upgrade if current version is higher or equal
  debug:
    msg: "⏭️  SKIPPING UPGRADE - Node {{ inventory_hostname }}: Current version ({{ current_k3s_version }}) is higher or equal to target ({{ k3s_target_version }}). No upgrade needed."
  when: 
    - "'master' in group_names or 'worker' in group_names"
    - version_check_result is defined
    - version_check_result.rc is defined
    - version_check_result.rc == 2
  run_once: true

- name: Check if upgrade is needed (only upgrade if current < target)
  shell: |
    python3 << 'EOF'
    import re
    import sys
    
    def parse_version(version_str):
        """Parse K3s version string (e.g., 'v1.32.8+k3s1') to tuple (major, minor, patch)"""
        if version_str == "not_installed":
            return (0, 0, 0)
        # Remove 'v' prefix and '+k3s1' suffix, extract version numbers
        version_clean = re.sub(r'^v', '', version_str)
        version_clean = re.sub(r'\+.*$', '', version_clean)
        parts = version_clean.split('.')
        major = int(parts[0]) if len(parts) > 0 else 0
        minor = int(parts[1]) if len(parts) > 1 else 0
        patch = int(parts[2]) if len(parts) > 2 else 0
        return (major, minor, patch)
    
    current = "{{ current_k3s_version }}".strip()
    target = "{{ k3s_target_version }}".strip()
    
    if current == "not_installed":
        # If not installed, upgrade needed
        print("upgrade_needed")
        sys.exit(0)
    
    if not target or target == "":
        print("upgrade_needed")  # If target not specified, assume upgrade needed
        sys.exit(0)
    
    current_ver = parse_version(current)
    target_ver = parse_version(target)
    
    # Only upgrade if current < target
    if current_ver < target_ver:
        print("upgrade_needed")
        sys.exit(0)
    else:
        print("skip_upgrade")
        sys.exit(1)
  register: upgrade_check_result
  changed_when: false
  failed_when: false
  when: 
    - "'master' in group_names or 'worker' in group_names"
    - current_k3s_version is defined
    - current_k3s_version != "not_installed"
    - k3s_target_version is defined

- name: Set upgrade_needed fact based on version comparison
  set_fact:
    upgrade_needed: "{{ (upgrade_check_result.stdout | default('skip_upgrade') | trim == 'upgrade_needed') or (upgrade_force | default(false)) }}"
  when: "'master' in group_names or 'worker' in group_names"

- name: Display upgrade decision
  debug:
    msg: "Node {{ inventory_hostname }}: Current={{ current_k3s_version }}, Target={{ k3s_target_version }}, Upgrade needed={{ upgrade_needed | default(false) }}, Reason={{ upgrade_check_result.stdout | default('version check skipped') }}"
  when: "'master' in group_names or 'worker' in group_names"

- name: Skip upgrade if version is higher or equal
  debug:
    msg: "⏭️  SKIP - Node {{ inventory_hostname }}: Current ({{ current_k3s_version }}) >= Target ({{ k3s_target_version }}), skipping upgrade"
  when: 
    - "'master' in group_names or 'worker' in group_names"
    - upgrade_needed is defined
    - not upgrade_needed

