---
# Upgrade Worker Nodes with Rolling Update Strategy
---

- name: Find home directory for UID 1000
  command: getent passwd 1000
  register: getent_passwd_output
  changed_when: false
  when: "'master' in group_names"

- name: Set home directory variable
  set_fact:
    user_home_directory: "{{ getent_passwd_output.stdout.split(':')[5] }}"
  when: 
  - "'master' in group_names" 
  - getent_passwd_output.stdout != ""

- name: Define the user name with UID 1000
  command: getent passwd 1000
  register: getent_passwd_result
  changed_when: false

- name: Set user name variable from getent passwd output
  set_fact:
    uid_1000_user: "{{ getent_passwd_result.stdout.split(':')[0] }}"
  when: getent_passwd_result.stdout != ''

- name: Get K3s token from first master
  shell: cat /var/lib/rancher/k3s/server/node-token
  register: k3s_token_raw
  when: "'master' in group_names"
  become: true
  changed_when: false
  run_once: true
  delegate_to: "{{ groups['master'][0] }}"

- name: Set K3s token fact
  set_fact:
    k3s_token: "{{ k3s_token_raw.stdout | default('') }}"
  when: k3s_token_raw.stdout is defined
  run_once: true

- name: Get keepalived VIP from vars
  set_fact:
    keepalived_vip: "{{ keepalived_vip | default('192.168.1.244') }}"
  run_once: true

- name: Count master nodes
  set_fact:
    master_count: "{{ groups['master'] | length | int }}"
  run_once: true

- name: Upgrade worker node (HA mode)
  block:
    - name: Drain worker node
      ansible.builtin.command:
        cmd: kubectl drain {{ inventory_hostname }} --ignore-daemonsets --delete-emptydir-data --timeout={{ upgrade_drain_timeout }}s --force
      become: true
      become_user: "{{ uid_1000_user }}"
      environment:
        KUBECONFIG: "{{ user_home_directory }}/.kube/config"
      when: 
        - "'worker' in group_names"
        - upgrade_needed | default(true)
        - (master_count | int) >= 3
      delegate_to: "{{ groups['master'][0] }}"

    - name: Upgrade K3s agent on worker (HA mode)
      shell: |
        export K3S_URL="https://{{ keepalived_vip }}:6443"
        export K3S_TOKEN="{{ k3s_token }}"
        export INSTALL_K3S_VERSION={{ k3s_target_version }}
        curl -sfL {{ k3s_install_url }} | sh -s - agent
      when: 
        - "'worker' in group_names"
        - upgrade_needed | default(true)
        - (master_count | int) >= 3
      become: true
      register: upgrade_worker_ha

    - name: Wait for K3s agent to be ready (HA mode)
      ansible.builtin.wait_for:
        path: /var/lib/rancher/k3s/agent/node-token
        state: present
      when: 
        - "'worker' in group_names"
        - upgrade_needed | default(true)
        - (master_count | int) >= 3
      become: true
      retries: 10
      delay: 10

    - name: Uncordon worker node (HA mode)
      ansible.builtin.command:
        cmd: kubectl uncordon {{ inventory_hostname }}
      become: true
      become_user: "{{ uid_1000_user }}"
      environment:
        KUBECONFIG: "{{ user_home_directory }}/.kube/config"
      when: 
        - "'worker' in group_names"
        - upgrade_needed | default(true)
        - (master_count | int) >= 3
      delegate_to: "{{ groups['master'][0] }}"

    - name: Wait for pods to stabilize after worker upgrade (HA mode)
      ansible.builtin.pause:
        seconds: "{{ upgrade_wait_for_pods }}"
      when: 
        - "'worker' in group_names"
        - upgrade_needed | default(true)
        - (master_count | int) >= 3

  when: 
    - "'worker' in group_names"
    - upgrade_needed | default(true)
    - (master_count | int) >= 3

- name: Upgrade worker node (Single Master mode)
  block:
    - name: Drain worker node
      ansible.builtin.command:
        cmd: kubectl drain {{ inventory_hostname }} --ignore-daemonsets --delete-emptydir-data --timeout={{ upgrade_drain_timeout }}s --force
      become: true
      become_user: "{{ uid_1000_user }}"
      environment:
        KUBECONFIG: "{{ user_home_directory }}/.kube/config"
      when: 
        - "'worker' in group_names"
        - upgrade_needed | default(true)
        - (master_count | int) < 3
      delegate_to: "{{ groups['master'][0] }}"

    - name: Upgrade K3s agent on worker (Single Master mode)
      shell: |
        export K3S_URL="https://{{ hostvars[groups['master'][0]]['ansible_host'] }}:6443"
        export K3S_TOKEN="{{ k3s_token }}"
        export INSTALL_K3S_VERSION={{ k3s_target_version }}
        curl -sfL {{ k3s_install_url }} | sh -
      when: 
        - "'worker' in group_names"
        - upgrade_needed | default(true)
        - (master_count | int) < 3
      become: true
      register: upgrade_worker_single

    - name: Wait for K3s agent to be ready (Single Master mode)
      ansible.builtin.wait_for:
        path: /var/lib/rancher/k3s/agent/node-token
        state: present
      when: 
        - "'worker' in group_names"
        - upgrade_needed | default(true)
        - (master_count | int) < 3
      become: true
      retries: 10
      delay: 10

    - name: Uncordon worker node (Single Master mode)
      ansible.builtin.command:
        cmd: kubectl uncordon {{ inventory_hostname }}
      become: true
      become_user: "{{ uid_1000_user }}"
      environment:
        KUBECONFIG: "{{ user_home_directory }}/.kube/config"
      when: 
        - "'worker' in group_names"
        - upgrade_needed | default(true)
        - (master_count | int) < 3
      delegate_to: "{{ groups['master'][0] }}"

    - name: Wait for pods to stabilize after worker upgrade (Single Master mode)
      ansible.builtin.pause:
        seconds: "{{ upgrade_wait_for_pods }}"
      when: 
        - "'worker' in group_names"
        - upgrade_needed | default(true)
        - (master_count | int) < 3

  when: 
    - "'worker' in group_names"
    - upgrade_needed | default(true)
    - (master_count | int) < 3

