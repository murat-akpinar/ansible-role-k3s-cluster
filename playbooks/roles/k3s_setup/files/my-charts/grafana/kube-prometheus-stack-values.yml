# kube-prometheus-stack values for HA setup (3+ masters)
# Master preferred, worker fallback strategy
# Includes: Prometheus, Grafana, Alertmanager, Node Exporter, Kube State Metrics

# Prometheus Configuration
prometheus:
  prometheusSpec:
    # Resources
    resources:
      limits:
        cpu: 1
        memory: 2Gi
      requests:
        cpu: 500m
        memory: 1Gi
    
    # Storage Configuration
    # Using longhorn-retain-2 for HA: 2 replicas for data redundancy
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn-retain-2
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi
    
    # Retention
    retention: 30d
    
    # Replicas for HA
    replicas: 2
    
    # Master preferred, worker fallback
    tolerations:
      - key: "node-role.kubernetes.io/master"
        operator: "Equal"
        value: "system"
        effect: "NoSchedule"
    
    affinity:
      nodeAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
                - key: node-role.kubernetes.io/master
                  operator: Exists
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - prometheus
            topologyKey: "kubernetes.io/hostname"

# Alertmanager Configuration
alertmanager:
  alertmanagerSpec:
    # Resources
    resources:
      limits:
        cpu: 500m
        memory: 1Gi
      requests:
        cpu: 250m
        memory: 500Mi
    
    # Storage Configuration
    # Using longhorn-retain-2 for HA: 2 replicas for data redundancy
    storage:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn-retain-2
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 2Gi
    
    # Replicas for HA
    replicas: 2
    
    # Master preferred, worker fallback
    tolerations:
      - key: "node-role.kubernetes.io/master"
        operator: "Equal"
        value: "system"
        effect: "NoSchedule"
    
    affinity:
      nodeAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            preference:
              matchExpressions:
                - key: node-role.kubernetes.io/master
                  operator: Exists
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
                - key: app.kubernetes.io/name
                  operator: In
                  values:
                    - alertmanager
            topologyKey: "kubernetes.io/hostname"

# Grafana Configuration
grafana:
  # Resources
  resources:
    limits:
      cpu: 500m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 500Mi
  
  # Persistence
  # Using longhorn-retain-2 for HA: 2 replicas for data redundancy
  persistence:
    enabled: true
    storageClassName: longhorn-retain-2
    accessModes:
      - ReadWriteOnce
    size: 10Gi
  
  # Admin credentials (will be auto-generated if not set)
  adminUser: admin
  adminPassword: admin  # Change this or use secret
  
  # Operator configuration
  operator:
    dashboardsConfigMapRefEnabled: false

# Node Exporter (enabled by default)
nodeExporter:
  enabled: true

# Kube State Metrics (enabled by default)
kubeStateMetrics:
  enabled: true
  # Master preferred, worker fallback
  tolerations:
    - key: "node-role.kubernetes.io/master"
      operator: "Equal"
      value: "system"
      effect: "NoSchedule"
  
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          preference:
            matchExpressions:
              - key: node-role.kubernetes.io/master
                operator: Exists

