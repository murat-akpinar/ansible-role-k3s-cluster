---
# ============================
# Display Installation Results
# ============================

- name: Find home directory for UID 1000
  command: getent passwd 1000
  register: getent_passwd_output
  changed_when: false
  when: "'master' in group_names"

- name: Set home directory variable
  set_fact:
    user_home_directory: "{{ getent_passwd_output.stdout.split(':')[5] }}"
  when: 
    - "'master' in group_names" 
    - getent_passwd_output.stdout != ""

- name: Get Ingress Controller LoadBalancer IP
  command: kubectl get svc -n ingress-nginx ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
  register: ingress_lb_ip
  failed_when: false
  changed_when: false
  when: 
    - inventory_hostname == 'master-1'
    - ingress_install | default(false)

- name: Retrieve Longhorn URL
  set_fact:
    longhorn_url: "https://longhorn.homelab.local"
  when: 
    - inventory_hostname == 'master-1'
    - longhorn_install | default(false)

- name: Retrieve Rancher bootstrap password
  shell: kubectl get secret --namespace cattle-system bootstrap-secret -o go-template='{% raw %}{{.data.bootstrapPassword|base64decode}}{{"\n"}}{% endraw %}' 2>/dev/null || echo ""
  register: rancher_bootstrap_password
  failed_when: false
  changed_when: false
  when: 
    - inventory_hostname == 'master-1'
    - rancher_install | default(false)

- name: Retrieve Rancher URL
  set_fact:
    rancher_url: "https://rancher.homelab.local"
  when: 
    - inventory_hostname == 'master-1'
    - rancher_install | default(false)

- name: Retrieve Grafana admin password
  shell: kubectl get secret --namespace monitoring kube-prometheus-stack-grafana -o jsonpath="{.data.admin-password}" 2>/dev/null | base64 --decode || echo ""
  register: grafana_admin_password
  failed_when: false
  changed_when: false
  when: 
    - inventory_hostname == 'master-1'
    - grafana_install | default(false)

- name: Retrieve Grafana admin user
  shell: kubectl get secret --namespace monitoring kube-prometheus-stack-grafana -o jsonpath="{.data.admin-user}" 2>/dev/null | base64 --decode || echo ""
  register: grafana_admin_user
  failed_when: false
  changed_when: false
  when: 
    - inventory_hostname == 'master-1'
    - grafana_install | default(false)

- name: Retrieve Grafana URL
  set_fact:
    grafana_url: "https://grafana.homelab.local"
  when: 
    - inventory_hostname == 'master-1'
    - grafana_install | default(false)

- name: Retrieve ArgoCD admin password
  shell: kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" 2>/dev/null | base64 -d || echo ""
  register: argocd_admin_password
  failed_when: false
  changed_when: false
  when: 
    - inventory_hostname == 'master-1'
    - argocd_install | default(false)

- name: Retrieve ArgoCD URL
  set_fact:
    argocd_url: "https://argocd.homelab.local"
  when: 
    - inventory_hostname == 'master-1'
    - argocd_install | default(false)

- name: Display Installation Results
  ansible.builtin.command:
    cmd: |
      echo "================================================================================"
      echo "K3S CLUSTER INSTALLATION RESULTS"
      echo "================================================================================"
      echo ""
      {% if ingress_install | default(false) %}
      echo "Ingress LoadBalancer IP: {{ ingress_lb_ip.stdout | default('N/A') }}"
      echo ""
      {% endif %}
      {% if longhorn_install | default(false) %}
      echo "LONGHORN"
      echo "URL:        {{ longhorn_url | default('N/A') }}"
      echo "Username:   (No authentication required)"
      echo "Password:   (No password required)"
      echo ""
      {% endif %}
      {% if rancher_install | default(false) %}
      echo "RANCHER"
      echo "URL:        {{ rancher_url | default('N/A') }}"
      echo "Username:   admin"
      echo "Password:   {{ rancher_bootstrap_password.stdout | default('N/A (Secret not found)') }}"
      echo ""
      {% endif %}
      {% if grafana_install | default(false) %}
      echo "GRAFANA"
      echo "URL:        {{ grafana_url | default('N/A') }}"
      echo "Username:   {{ grafana_admin_user.stdout | default('admin') }}"
      echo "Password:   {{ grafana_admin_password.stdout | default('N/A (Secret not found)') }}"
      echo ""
      {% endif %}
      {% if argocd_install | default(false) %}
      echo "ARGOCD"
      echo "URL:        {{ argocd_url | default('N/A') }}"
      echo "Username:   admin"
      echo "Password:   {{ argocd_admin_password.stdout | default('N/A (Secret not found)') }}"
      echo ""
      {% endif %}
      echo "--------------------------------------------------------------------------------"
      echo "/etc/hosts CONFIGURATION - Add the following lines:"
      {% if ingress_lb_ip.stdout is defined and ingress_lb_ip.stdout != '' %}
      {% if longhorn_install | default(false) %}
      echo "{{ ingress_lb_ip.stdout }}    longhorn.homelab.local"
      {% endif %}
      {% if rancher_install | default(false) %}
      echo "{{ ingress_lb_ip.stdout }}    rancher.homelab.local"
      {% endif %}
      {% if grafana_install | default(false) %}
      echo "{{ ingress_lb_ip.stdout }}    grafana.homelab.local"
      {% endif %}
      {% if argocd_install | default(false) %}
      echo "{{ ingress_lb_ip.stdout }}    argocd.homelab.local"
      {% endif %}
      {% endif %}
      echo "================================================================================"
  register: installation_results
  changed_when: false
  when: inventory_hostname == 'master-1'

- name: Show Installation Results
  debug:
    msg: "{{ installation_results.stdout }}"
  when: inventory_hostname == 'master-1'

